{% extends "base.html" %}
{% block title %}Set Preferences - CollegeFinder{% endblock %}
{% block main_class %}container mt-5 pt-5{% endblock %}

{% block content %}
<div class="card shadow-sm rounded-4 p-4">
  <h3 class="mb-3" style="color: white;">Set Your Preferences (Optional)</h3>
  <p class="text-muted">Choose your preferred colleges and branches to get personalized recommendations, or generate recommendations based on your profile alone.</p>

  <div class="alert alert-info">
    <strong>Note:</strong> Preferences are optional. You can generate recommendations based on your profile alone (percentile and category) or add specific college/branch preferences.
  </div>

  <script id="initial-prefs" type="application/json">
    { "colleges": {{ preferred_colleges|tojson|default('[]') }}, "branches": {{ preferred_branches|tojson|default('[]') }} }
  </script>

  <form method="POST" id="preferences-form" novalidate>
    <div class="mb-4">
      <label class="form-label fw-bold">Preferred Colleges (Optional - Max 10)</label>
      <div class="input-group mb-2">
        <input type="text" id="college-search" class="form-control" autocomplete="off">
        <button type="button" id="college-add" class="btn btn-outline-primary">Add</button>
      </div>
      <div id="college-suggestions" class="list-group position-relative" style="z-index:2000;"></div>
      <small class="text-muted d-block mt-2">Optional: Search and rank your preferred colleges in order of preference</small>
      <div id="college-selected" class="mt-3"></div>
      <input type="hidden" name="preferred_colleges" id="preferred_colleges_input" value="">
    </div>

    <div class="mb-4">
      <label class="form-label fw-bold">Preferred Branches (Optional - Max 10)</label>
      <div class="input-group mb-2">
        <input type="text" id="branch-search" class="form-control" autocomplete="off">
        <button type="button" id="branch-add" class="btn btn-outline-primary">Add</button>
      </div>
      <div id="branch-suggestions" class="list-group position-relative" style="z-index:2000;"></div>
      <small class="text-muted d-block mt-2">Optional: Search and rank your preferred branches in order of preference</small>
      <div id="branch-selected" class="mt-3"></div>
      <input type="hidden" name="preferred_branches" id="preferred_branches_input" value="">
    </div>

    <div class="d-flex gap-2">
      <button type="submit" class="btn btn-outline-secondary">Save Preferences</button>
      <button type="button" id="generate-btn" class="btn btn-primary">Generate Recommendations</button>
    </div>
  </form>
</div>

<script>
(() => {
  let initial = { colleges: [], branches: [] };
  try {
    const el = document.getElementById('initial-prefs');
    if (el && el.textContent.trim()) initial = JSON.parse(el.textContent);
  } catch(e){ console.error('initial prefs parse failed', e); }

  const MAX_ITEMS = 10;
  let selectedCollegeList = Array.isArray(initial.colleges) ? [...initial.colleges] : [];
  let selectedBranchList  = Array.isArray(initial.branches) ? [...initial.branches] : [];

  const collegeSearch = document.getElementById('college-search');
  const collegeSuggestions = document.getElementById('college-suggestions');
  const collegeSelectedDiv = document.getElementById('college-selected');
  const preferredCollegesInput = document.getElementById('preferred_colleges_input');
  const collegeAddBtn = document.getElementById('college-add');

  const branchSearch = document.getElementById('branch-search');
  const branchSuggestions = document.getElementById('branch-suggestions');
  const branchSelectedDiv = document.getElementById('branch-selected');
  const preferredBranchesInput = document.getElementById('preferred_branches_input');
  const branchAddBtn = document.getElementById('branch-add');

  const preferencesForm = document.getElementById('preferences-form');
  const generateBtn = document.getElementById('generate-btn');

  function debounce(fn, wait = 220){
    let t;
    return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), wait); };
  }

  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  function renderSelected(){
    collegeSelectedDiv.innerHTML = '';
    selectedCollegeList.forEach((name, idx) => {
      const item = document.createElement('div');
      item.className = 'mb-2 d-inline-flex align-items-center';
      item.innerHTML = `<span class="badge bg-primary me-2" style="font-size:0.95rem;"><strong>${idx+1}.</strong> ${escapeHtml(name)}</span>
                        <button type="button" class="btn btn-sm btn-outline-danger remove-btn" data-name="${escapeHtml(name)}" data-type="college">✕</button>`;
      collegeSelectedDiv.appendChild(item);
    });

    branchSelectedDiv.innerHTML = '';
    selectedBranchList.forEach((name, idx) => {
      const item = document.createElement('div');
      item.className = 'mb-2 d-inline-flex align-items-center';
      item.innerHTML = `<span class="badge bg-secondary me-2" style="font-size:0.95rem;"><strong>${idx+1}.</strong> ${escapeHtml(name)}</span>
                        <button type="button" class="btn btn-sm btn-outline-danger remove-btn" data-name="${escapeHtml(name)}" data-type="branch">✕</button>`;
      branchSelectedDiv.appendChild(item);
    });

    preferredCollegesInput.value = selectedCollegeList.join(',');
    preferredBranchesInput.value = selectedBranchList.join(',');

    document.querySelectorAll('.remove-btn').forEach(btn=>{
      btn.onclick = ()=>{
        const name = btn.getAttribute('data-name');
        const type = btn.getAttribute('data-type');
        if (type === 'college') selectedCollegeList = selectedCollegeList.filter(x=>x!==name);
        else selectedBranchList = selectedBranchList.filter(x=>x!==name);
        renderSelected();
      };
    });
  }

  function dedupeAndLimit(arr){
    return Array.from(new Set(arr)).slice(0, MAX_ITEMS);
  }

  function showSuggestions(container, items, onClick){
    container.innerHTML = '';
    const seen = new Set();
    items.forEach(it=>{
      if(!it || !it.name) return;
      if(seen.has(it.name)) return;
      seen.add(it.name);
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'list-group-item list-group-item-action';
      btn.textContent = it.name;
      btn.onclick = ()=> onClick(it);
      container.appendChild(btn);
    });
  }

  const fetchCollegeSuggestions = debounce(async ()=>{
    const q = collegeSearch.value.trim();
    if (!q) { collegeSuggestions.innerHTML=''; return; }
    try {
      const res = await fetch(`/api/colleges?q=${encodeURIComponent(q)}&limit=8`);
      if (!res.ok) throw new Error('network');
      const data = await res.json();
      showSuggestions(collegeSuggestions, data, it=>{
        if (!selectedCollegeList.includes(it.name) && selectedCollegeList.length < MAX_ITEMS) {
          selectedCollegeList.push(it.name);
          selectedCollegeList = dedupeAndLimit(selectedCollegeList);
          renderSelected();
        }
        collegeSearch.value = '';
        collegeSuggestions.innerHTML='';
      });
    } catch(e){ console.error('college fetch', e); }
  }, 200);

  const fetchBranchSuggestions = debounce(async ()=>{
    const q = branchSearch.value.trim();
    if (!q) { branchSuggestions.innerHTML=''; return; }
    try {
      const res = await fetch(`/api/branches?q=${encodeURIComponent(q)}&limit=8`);
      if (!res.ok) throw new Error('network');
      const data = await res.json();
      showSuggestions(branchSuggestions, data, it=>{
        if (!selectedBranchList.includes(it.name) && selectedBranchList.length < MAX_ITEMS) {
          selectedBranchList.push(it.name);
          selectedBranchList = dedupeAndLimit(selectedBranchList);
          renderSelected();
        }
        branchSearch.value = '';
        branchSuggestions.innerHTML='';
      });
    } catch(e){ console.error('branch fetch', e); }
  }, 200);

  collegeSearch.addEventListener('input', fetchCollegeSuggestions);
  branchSearch.addEventListener('input', fetchBranchSuggestions);

  collegeAddBtn.onclick = ()=>{
    const v = collegeSearch.value.trim();
    if (!v) return;
    if (!selectedCollegeList.includes(v) && selectedCollegeList.length < MAX_ITEMS) selectedCollegeList.push(v);
    selectedCollegeList = dedupeAndLimit(selectedCollegeList);
    renderSelected();
    collegeSearch.value='';
    collegeSuggestions.innerHTML='';
  };

  branchAddBtn.onclick = ()=>{
    const v = branchSearch.value.trim();
    if (!v) return;
    if (!selectedBranchList.includes(v) && selectedBranchList.length < MAX_ITEMS) selectedBranchList.push(v);
    selectedBranchList = dedupeAndLimit(selectedBranchList);
    renderSelected();
    branchSearch.value='';
    branchSuggestions.innerHTML='';
  };

  generateBtn.onclick = ()=> {
    preferredCollegesInput.value = selectedCollegeList.join(',');
    preferredBranchesInput.value = selectedBranchList.join(',');
    preferencesForm.submit();
  };

  preferencesForm.addEventListener('submit', ()=>{
    preferredCollegesInput.value = selectedCollegeList.join(',');
    preferredBranchesInput.value = selectedBranchList.join(',');
  });

  renderSelected();
})();
</script>
{% endblock %}
